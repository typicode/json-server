name: Semgrep

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '30 3 * * 2'   # weekly on Tue 03:30 UTC
  workflow_dispatch:

permissions:
  contents: read

jobs:
  semgrep:
    name: Semgrep scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-node-18-${{ hashFiles('**/package-lock.json', '**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-18-

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi
        - name: Setup Python
          uses: actions/setup-python@v4
          with:
            python-version: '3.11'

        - name: Install Semgrep
          run: |
            python -m pip install --upgrade pip
            pip install semgrep

        - name: Run Semgrep scan (generate SARIF)
          run: |
            semgrep scan --sarif --output=semgrep.sarif --config=p/ci || true
          continue-on-error: true

        - name: Run Semgrep CI (optional, reports to semgrep.dev)
          if: ${{ secrets.SEMGREP_APP_TOKEN != '' }}
          env:
            SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
          run: semgrep ci --config=p/ci || true
          continue-on-error: true

        # Upload SARIF to GitHub Security tab (ensures results show in Security -> Code scanning)
        - name: Upload SARIF to security tab
          uses: github/codeql-action/upload-sarif@v4
          with:
            sarif_file: semgrep.sarif
            category: semgrep
          if: always()

        # Keep SARIF as artifact for debugging
        - name: Upload Semgrep SARIF as artifact
          uses: actions/upload-artifact@v4
          with:
            name: semgrep-sarif
            path: semgrep.sarif
            retention-days: 30
          if: always()
